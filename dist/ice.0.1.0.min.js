/*
 ice V0.1.0
 @author:JOU<huzhen555@qq.com>
 License:MIT
*/
!function(t,e){"use strict";function n(t){return function(e,n){var o="[ice:"+(t?t+"-":"")+e+"] "+n;return new Error(o)}}function o(t){return null!==t?t instanceof Array?"array":typeof t:"null"}function a(t,e,n){var a,r=o(t),i=o(e),c=0;if("array"===r&&n===!0)for(;c<t.length&&(a=e(t[c],c,t),a!==!1);c++);else{if("object"!==r&&n===!0)throw K("target","第一个参数类型必须为array或object");for(c in t)if(a=e(t[c],c,t),a===!1)break}if("function"!==i)throw K("callback","第二个参数类型必须为function")}function r(t,e){if("array"===o(t)){for(var n=t.length;--n>=0;)if(t[n]===e)return!0;return!1}throw K("function inArray:array","第一个参数必须为数组")}function i(t,e){if("object"===o(t)){var n=!1;return a(t,function(t,o){if(o===e)return n=t,!1}),n}throw K("function hasKey:object","检测对象必须为object类型")}function c(){var t,n=arguments[0],i=o(arguments[0]),c=G.call(arguments,1);if("array"!==i&&"object"!==i&&"function"!==i)throw K(i,"合并父体类型需为Array、Object或Function");return a(c,function(c){t=o(c),"array"===i?"array"===t||"object"===t?a(c,function(t){r(n,t)||V.call(n,t)}):null!==t&&t!==e&&V.call(n,c):"object"!==i&&"function"!==i||"object"===t&&a(c,function(t,e){n[e]=t})}),n}function l(t){var e=!0,n=o(t);if("array"!==n&&"object"!==n)throw K("object","参数类型必须为array或object");return a(t,function(){return e=!1,!1}),e}function u(t){if("string"!==o(t))throw K("arg-type","参数类型必须为string");return nt.call(t,/(^\s*)|(\s*$)/g,"")}function s(t,e){return(e||at).querySelector(t)}function f(t,e){return(e||at).querySelectorAll(t)}function d(t,e){var n=t.getElementsByTagName?t.getElementsByTagName(e||"*"):t.querySelectorAll?t.querySelectorAll(e||"*"):[];return t.nodeName===Y.call(e)?Q.call(G.call(n),[t]):G.call(n)}function p(t,e,n){if(1!==t.nodeType&&9!==t.nodeType&&t.self!==t)throw K("function on:node","node参数必须为node对象");if("string"!==o(e))throw K("function on:types","types参数类型必须为string");if("function"!==o(n))throw K("function on:listener","listener参数类型必须为function");return e=tt.call(e," "),t.addEventListener?a(e,function(e){e&&t.addEventListener(e,n)}):a(e,function(e){e&&t.attachEvent("on"+e,n)}),t}function h(t,e){var n=at.createElement("script");n.type="text/javascript",a(t.attributes,function(t){2===t.nodeType&&n.setAttribute(t.nodeName,t.nodeValue)}),t.src?(n.async=!0,p(n,"load readystatechange",function(t){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.raeadyState||e&&e(t),n.parentNode.removeChild(n)}),p(n,"error",function(){n.parentNode.removeChild(n)}),at.head.appendChild(n)):t.text&&(n.text=t.text||"",at.head.appendChild(n).parentNode.removeChild(n))}function g(t){var e=o(t);if("string"===e){var n=at.createElement("script");n.type="text/javascript",n.text=t,h(n)}else if("object"===e&&1===t.nodeType&&"script"===Z.call(t.nodeName))h(t);else{if("array"!==e)throw K("arg","参数必须为javascript代码片段、script标签或script标签数组");var r=G.call(t,0);a(t,function(t){return W.call(r,0,1),t.src?(h(t,function(){r.length>0&&g(r)}),!1):void h(t)})}}function y(t){if(1!==t.nodeType)throw K("context","元素类型必须是dom节点");return t.textContent="",t}function m(t,e){var n,r,i,c=/<|&#?\w+;/,u=o(e),s=0,f=[],p=[];if(1===t.nodeType){if("string"!==u||c.test(e))if("object"===u)e.nodeType&&V.call(f,e);else{for(n=at.createDocumentFragment(),r=n.appendChild(at.createElement("div")),r.innerHTML=e;s<r.childNodes.length;s++)f.push(r.childNodes[s]);r.textContent=""}else V.call(f,at.createTextNode(e));return n.textContent="",a(f,function(e){if(t.appendChild(e),1===e.nodeType)for(r=d(e,"script"),s=0;i=r[s++];)V.call(p,i)}),l(p)||g(p),t}throw K("context","context必须为DOM节点")}function b(t,e){return t=y(t),t=m(t,e)}function v(t,e){if("function"!==o(t))throw K("function","参数类型必须为function");setTimeout(function(){t.apply(null,e)},0)}function M(t,e,n){if(3!==arguments.length)throw K("function:replaceAll","必须传入被替换字符串、查找替换的字符串和替换的字符串三个参数");if("string"!==o(t)||"string"!==o(e)||"string"!==o(n))throw K("function:replaceAll","函数所有参数类型都必须为string");return e=tt.call(e,""),a(e,function(t,e,n){n[e]=["$","(",")","*","+",".","[","]","?","\\","^","{","}","|"].indexOf(t)!==-1?"\\"+t:t}),nt.call(t,new RegExp(e.join(""),"gm"),n)}function T(t,e){e=!!e;var n=/\./g,o=/\//g,a=".",r="/";return e?nt.call(t,o,a):nt.call(t,n,r)}function w(t,e){t.currentPath=e}function x(t){return t.currentPath||""}function j(t,e){var n,o=Q.call([],t);if("/"===E.params.moduleSeparator)for(var r=0;r<o.length;)""!==o[r]?(e(o[r],o[r+1]||""),r+=2):r++;else a(o,function(t){""!==t&&(n=tt.call(t,E.params.moduleSeparator),e(n[0],n[1]))})}function S(){}function C(t){function e(){u===i&&(u=c,o=arguments,a(s,function(t){t.onFulfilled&&t.onFulfilled.apply(null,o)}))}function n(t){u===i&&(u=l,r=t,a(s,function(t){t.onRejected&&t.onRejected(r)}))}if("function"!=typeof t)throw K("function Promise","构造函数需传入一个函数参数");var o,r,i=0,c=1,l=2,u=i,s=[];this._isThenable=function(t){var e=typeof t;if(t&&("object"===e||"function"===e)){var n=t.then;if("function"==typeof n)return!0}return!1},this.handle=function(t){u===i?V.call(s,t):u===c&&"function"==typeof t.onFulfilled?t.onFulfilled.apply(null,o):u===l&&"function"==typeof t.onRejected&&t.onRejected(r)},t(e,n)}function N(){}function R(){}function A(e){return new C(function(n,r){var i,l,u,s=/%20/g,f=/#.*$/,d=/([?&])_=[^&]*/,p=/\?/,h=/^(?:GET|HEAD)$/;if(e.resolve=n,e.reject=r,e=c({},ct,e||{}),e.hasContent=!h.test(e.method=Y.call(e.method)),e.type=it.test(e.type=Y.call(e.type||""))?e.type:"TEXT","object"===o(e).data){var y=[];a(e.data,function(t,e){V.call(y,e+"="+t)}),e.data=z.call(y,"&")}if(e.hasContent?e.data&&"string"===o(e.data)&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&(e.data=e.data.replace(s,"+")):(i=e.url.replace(f,""),l=G.call(e.url,i.length),i+=e.data?(p.test(i)?"&":"?")+e.data:"",i=i.replace(d,""),i+=e.cache===!1?(p.test(i)?"&":"?")+"_="+Date.now():"",e.url=i+(l||"")),t.XMLHttpRequest)u=new XMLHttpRequest;else{if(!t.ActiveXObject)throw D("create","创建XHR失败");a(lt,function(e){try{u=new t.ActiveXObject(e)}catch(n){}})}u.open(e.method,e.url,e.async),e.hasContent&&e.data&&e.contentType&&u.setRequestHeader("Content-Type",e.contentType),u.onload=function(){if((u.status>=200&&u.status<300||304===u.status)&&e.resolve){var t,n={TEXT:function(){t=u.responseText},JSON:function(){try{t=JSON.parse(u.responseText)}catch(e){t=""}},SCRIPT:function(){t=u.responseText,g(t)}};n[e.type](),e.success&&e.success(t)||e.resolve(t)}else e.reject&&(e.error&&e.error(u.responseText)||e.reject(u.responseText))},u.onerror=function(t){e.error&&e.error(t)||e.reject(t)},u.onabort=function(){};try{u.send(e.hasContent&&e.data||null)}catch(m){throw D("send",m)}})}function L(t,n,a,r){"string"===o(a)&&r===e&&(r=a,a=e),"function"===o(n)?(a=n,n=e):it.test(Y.call(n||""))&&(r=n,n=e);var i={url:t};return n&&(i.args=n),a&&(i.success=a),r&&(i.type=r),A(i)}function P(t,n,a,r){"string"===o(a)&&r===e&&(r=a,a=e),"function"===o(n)?(a=n,n=e):it.test(Y.call(n||""))&&(r=n,n=e);var i={url:t,method:"POST"};return n&&(i.data=n),a&&(i.success=a),r&&(i.type=r),A(i)}function H(e,n,r,i,c,l){var u,s,f,d,p,h,g,y,m,v,T=":m",j=":v",S=[];if("string"===o(e)?f=[{url:e,entity:n,title:r,isCache:i}]:(f=e,c=n,l=r),a(f,function(t){u=o(t.title),s=t.entity.getAttribute(H.aModule),h=s+"_"+t.url,g=E.params.urlRule,t.isCache===!0&&(d=Tt.getRedirect(h))?b(t.entity,d):(g=M(g||"",T,s),g=M(g||"",j,t.url),y=g.indexOf("/"),g="false"!==t.entity.getAttribute(H.aBase)&&E.params.base.url.length>0?E.params.base.url+(0===y?et.call(g,1):g):0===y?g:"/"+g,L(g).done(function(e){try{e=JSON.parse(e),p=e[E.params.htmlKey]}catch(n){p=e}b(t.entity,p),t.isCache===!0&&Tt.addRedirect(h,p),t.title="string"===u?t.title:"function"===u?t.title(e[E.params.codeKey]||null)||null:null}),"string"===o(t.title)&&(m=at.title,at.title=t.title),v=x(t.entity),w(t.entity,t.url),V.call(S,{url:v,moduleName:s,cache:t.isCache,title:m}),c===!0&&H.setModuleRecord(s,t.url,!0))}),c===!0){if(!H.history.entity.pushState)throw q("History API","浏览器不支持HTML5 History API");H.history.setState(H.history.signature,S,!0),l===!0||H.history.push(null,k.title,H.getFormatModuleRecord()),H.history.setState(t.location.pathname,null)}}function O(){}function X(){}function E(t){if("object"!==o(t))throw $("params","配置参数为参数对象");var n,a={base:{url:"",plugin:"",driver:"",lang:""},stateMark:xt[0],redirectCache:!0,codeKey:"code",htmlKey:"html",moduleSeparator:"-",urlRule:":m/:v.html",header:{}};l(t)||(t.base!==e&&(t.base.url!==e&&(n=o(t.base.url),t.base.url="string"===n?t.base.url:"function"===n?t.base.url():"",t.base.url="/"===t.base.url.substr(-1,1)?t.base.url:t.base.url+"/"),t.base.plugin!==e&&(n=o(t.base.plugin),t.base.plugin="string"===n?t.base.plugin:"function"===n?t.base.plugin():"",t.base.plugin="/"===t.base.plugin.substr(-1,1)?t.base.plugin:t.base.plugin+"/"),t.base.driver!==e&&(n=o(t.base.driver),t.base.driver="string"===n?t.base.driver:"function"===n?t.base.driver():"",t.base.driver="/"===t.base.driver.substr(-1,1)?t.base.driver:t.base.driver+"/")),t.base!==e&&t.base.lang!==e&&(n=o(t.base.lang),t.base.lang="string"===n?t.base.lang:"function"===n?t.base.lang():"",t.base.lang="/"===t.base.lang.substr(-1,1)?t.base.lang:t.base.lang+"/"),t.stateMark=xt.indexOf(t.stateMark)===-1?xt[0]:t.stateMark,t.redirectCache=t.redirectCache!==!1),t.base=c(a.base,t.base),c(E,{params:c(a,t)})}function F(n,r){if(r===!0){if(n===e||null===n||1!==n.nodeType&&11!==n.nodeType)throw K("function control:node","control方法要求传入一个有效的node对象或DocumentFragment对象")}else r!==e||n!==e&&null!==n||(n=s("body"));var i,c,l,u,d,h,g,y=[],m={};1===n.nodeType&&null!==n.getAttribute(H.aModule)&&V.call(y,n),y=Q.call(y,G.call(f("*["+H.aModule+"]",n))),a(y,function(t){return 1===t.nodeType&&void((i=t.getAttribute(H.aSrc))&&(c=t.getAttribute(H.aCache),i=H.getModuleRecord(t.getAttribute(H.aModule))||i,w(t,i),H(i,t,null,"true"===c||E.params.redirectCache===!0&&"false"!==c)))}),a(G.call(f("*["+H.aHref+"]")),function(t){"LINK"!==t.nodeName&&t.getAttribute(H.aTargetMod)&&p(t,"click",H.click)}),p(t,"popstate",function(e){l=H.history.getState(t.location.pathname),u={},d={},m={},h=[],"array"===o(l)&&l.length>0?(1===l.length?V.call(h,{url:l[0].url,entity:s("*["+H.aModule+"="+l[0].moduleName+"]"),title:l[0].title,isCache:l[0].cache}):a(l,function(t){V.call(h,{url:t.url,entity:s("*["+H.aModule+"="+t.moduleName+"]"),title:t.title,isCache:t.cache})}),H(h,!0,!0)):(j(tt.call(H.history.signature,"/"),function(t,e){u[t]=e}),j(tt.call(t.location.pathname,"/"),function(t,e){d[t]=e}),a(d,function(t,e){u[e]!==t&&(m[e]=t)}),a(u,function(t,e){d[e]!==t&&(m[e]=null)}),a(m,function(t,e){g=s("*["+H.aModule+"="+e+"]"),t=null===t?g.getAttribute(H.aSrc):t,H(t,g,E.params.header[t],"false"!==g.getAttribute(H.aCache)&&E.params.redirectCache,!0,!0)}))})}function k(t,n,r,i){if(!n&&!r)throw K("function module","至少需要传入模块主函数参数");n&&!r&&(r=n,n=e);var c=o(n),l=o(r);if(n!==e&&null!==n&&"array"!==c)throw K("function module:dependence","方法第一个参数类型为Array，也可不传入第一个参数或传入null，方法将自动忽略此参数");if("function"!==l)throw K("function module:factory","至少需要传入模块主函数参数，而不是其他类型参数");var s,f=/^function\s*\((.*)\)\s*/,d=tt.call(f.exec(r.toString())[1],",");a(d,function(t,e,n){n[e]=u(t)}),n="array"===o(n)?G.call(n,0,d.length-1):n,wt.putLoadModules(t,{type:i,deps:n,factory:r,args:d}),"array"===o(n)&&a(n,function(t){t=T(t,!0),Tt.componentFactory(t,gt)||(wt.putWaitingModuleName(t),wt.putLoadingModuleName(t)),s=at.createElement("script"),s.src=E.params.base.plugin+t+wt.suffix,s.setAttribute(wt.moduleName,T(t)),h(s,wt.onScriptLoaded)})}function I(){var e=f("script[config]");e.length>0?A({url:e[e.length-1].getAttribute("config"),async:!1,type:"SCRIPT"}):E({}),j(tt.call(t.location.pathname,"/"),function(t,e){H.setModuleRecord(t,e)}),H.history.setState(t.location.pathname,null),v(F),dt=st,Tt.queueInvoke()}var q=n("env"),K=n("arg"),D=n("request"),$=n("config"),_=n("runtime"),B=n("module");if("undefined"==typeof t||"object"!=typeof t.document)throw q("browser","ice只能在浏览器环境中运行...");var J=[],U="",G=J.slice,W=J.splice,V=J.push,z=J.join,Q=J.concat,Y=U.toUpperCase,Z=U.toLowerCase,tt=U.split,et=U.substr,nt=U.replace,ot=(Object.prototype.toString,Object.prototype.hasOwnProperty),at=(Object.prototype.isPrototypeOf,t.document),rt=t.ice||(t.ice={}),it=/^(?:TEXT|JSON|SCRIPT)$/,ct={method:"GET",url:"",data:"",async:!0,cache:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"TEXT"},lt=(at.documentMode,["Microsoft.XMLHTTP","MSXML.XMLHTTP","Msxml2.XMLHTTP.7.0","Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.5.0","Msxml2.XMLHTTP.4.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP"]),ut=0,st=1,ft=2,dt=ut,pt=1,ht=2,gt=3,yt=4,mt="builtIn",bt="external",vt=c({},{"typeof":o,inArray:r,hasKey:i,extend:c,isEmpty:l,trim:u,s:s,S:f,clear:y,append:m,html:b,run:v,replaceAll:M});C.prototype={then:function(t,e){var n=this;return new C(function(o,a){n.handle({onFulfilled:function(){var e="function"==typeof t&&t.apply(null,arguments)||arguments;n._isThenable(e)&&e.then(function(){o()},function(t){a(t)})},onRejected:function(t){var n="function"==typeof e&&e(t)||t;a(n)}})})},done:function(t){return this.handle({onFulfilled:t}),this},fail:function(t){return this.handle({onRejected:t}),this},always:function(t){this.handle({onFulfilled:t,onRejected:t})}},C.when=function(){};var Mt=c({},{request:A,get:L,post:P}),Tt=function(){function t(t,e){a(t,function(t,n){if(ot.call(r[e],n))throw B("plugin",n+"插件已存在");r[e][n]=t})}function n(t){a(t,function(t,e){if(ot.call(i,e))throw B("driver",e+"元素驱动器已存在");i[e]=t})}var r={builtIn:{},external:{}},i={},c={},l={page:null,module:[]};return{componentCreater:function(a,r,i){var c,l=o(a);return"object"===l?(i=r,r=a,a=e):(c=r,r={},r[a]=c),i===mt||i===bt?t(r,i):i===yt&&n(r),c||r},componentFactory:function(t,n){return n===gt||n===e?r[mt][t]||r[bt][t]:n===yt?i[t]:null},addRedirect:function(t,e){if(ot.call(c,t))throw B("module",t+"页面模块已存在");c[t]=e},getRedirect:function(t){return c[t]},setPageFactory:function(t){"function"===o(t)&&(l.page=t)},addUnexecutedModule:function(t){"function"===o(t)&&V.call(l.module,t)},queueInvoke:function(){dt===st&&"function"===o(l.page)?l.page():dt===ft&&l.module.length>0&&a(l.module,function(t){"function"===o(t)&&t()})}}}();c(H,{aModule:"ice-module",aSrc:"ice-src",aCache:"ice-cache",aBase:"ice-base",aLoading:"ice-loading",aFinish:"ice-finish",aHref:"href",aAction:"action",aTargetMod:"ice-target-module"}),c(H,{history:{entity:t.history,replace:function(t,e,n){this.entity.replaceState(t,e,n)},push:function(t,e,n){this.entity.pushState(t,e,n)},getOriginalState:function(){return this.entity.state},state:{},signature:null,setState:function(t,e,n){this.state[t]=e,n===!0||(this.signature=t)},getState:function(t){return this.state[t]}},moduleRecord:{},setModuleRecord:function(t,e,n){if(H.moduleRecord[t]=e,n===!0){var r={};a(H.moduleRecord,function(t,e){"object"===o(s("*[ice-module="+e+"]"))&&(r[e]=t)}),H.moduleRecord=r}},getModuleRecord:function(t){return H.moduleRecord[t]},getFormatModuleRecord:function(){var t=[];return a(H.moduleRecord,function(e,n){V.call(t,n+(E.params.moduleSeparator||"")+e)}),"/"+z.call(t,"/")},click:function(t){var e=this.getAttribute(H.aTargetMod),n=this.getAttribute(H.aHref),a=this.getAttribute(H.aCache),r=s("*["+H.aModule+"="+e+"]");if(t.preventDefault(),"object"!==o(r))throw B("module","找不到"+e+"模块");x(r)===n||H(n,r,E.params.header[n],"true"===a||E.params.redirectCache===!0&&"false"!==a,!0)}});var wt={suffix:".js",moduleName:"data-moduleName",topModuleName:"*",context:{loadModules:{},waiting:[],loadingModules:{pointer:0,names:[]}},init:function(){this.context.loadModules={},this.context.waiting=[],this.context.loadingModules.pointer=0,this.context.loadingModules.names=[]},putLoadModules:function(t,e){this.context.loadModules[t]=e},putWaitingModuleName:function(t){"array"===o(this.context.waiting)&&V.call(this.context.waiting,t)},putLoadingModuleName:function(t){"array"===o(this.context.loadingModules.names)&&V.call(this.context.loadingModules.names,t)},getLoadingModuleName:function(){return!l(this.context.loadingModules.names)&&this.context.loadingModules.pointer>=0&&this.context.loadingModules.names[this.context.loadingModules.pointer++]},inject:function(t){var e,n,r=[O],i=wt;return"array"===o(t.deps)&&a(t.deps,function(t){(e=Tt.componentFactory(t,gt))?V.call(r,e):(e=i.inject(i.context.loadModules[t]),Tt.componentCreater(t,e,bt),V.call(r,e))}),t.type===pt||t.type===ht?n=function(){t.factory.apply(null,r)}:t.type===gt?n=t.factory.apply(null,r):t.type===yt,n},onScriptLoaded:function(t){var e,n=wt,o=n.context.waiting.indexOf(t.target.getAttribute(n.moduleName));o!==-1&&W.call(n.context.waiting,o,1),0===n.context.waiting.length&&(e=n.inject(n.context.loadModules[n.topModuleName]),n.factoryInvoke(e,n.context.loadModules[n.topModuleName].type))},factoryInvoke:function(t,e){if(e===pt)if(dt===ut)Tt.setPageFactory(t);else{if(dt!==st)throw _("error","页面状态错误(page)");t&&t(),dt=ft,Tt.queueInvoke()}else if(e===ht)if(dt===st)Tt.addUnexecutedModule(t);else{if(dt!==ft)throw _("error","页面状态错误(module)");t&&t()}}};Tt.componentCreater({event:S,Promise:C,animation:N,language:R,util:vt,http:Mt},mt),c(O,{refreshModule:X});var xt=["@","$","^","*","|",":","~","!"];c(rt,{config:E}),c(rt,{page:function(t,e){return I(),wt.init(),k(wt.topModuleName,t,e,pt),this},module:function(t,e){return wt.init(),k(wt.topModuleName,t,e,ht),this},control:function(t){F(t,!0)}}),c(t,{plugin:function(t,e){k(wt.getLoadingModuleName()||"",t,e,gt)},driver:function(t,e){k("",t,e,yt)}})}(window);